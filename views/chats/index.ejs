<% include ../partials/head %>
<% include ../partials/nav %>
<% include ../partials/scripts %>
<aside class="chat-aside">
    <div class="chat-heading">Chats</div>
    <div class="chat-list" id="chat-list">
        <% chats.forEach(function(chat) { %>
            <div class="chat-item">
                <a href="#" data-chat-id="<%= chat._id %>"><%= chat.name %></a>
            </div>
        <% }); %>
    </div>
</aside>
<main class="with-aside with-chat">
    <div class="chat-history" id="chat-history"></div>
</main>
<footer class="chat-footer with-aside">
    <form class="chat-form" id="chat-form" data-chat-id="">
        <input type="text" class="form-control" id="message-input" placeholder="Type your message here..."/>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js" integrity="sha256-ABVkpwb9K9PxubvRrHMkk6wmWcIHUE9eBxNZLXYQ84k=" crossorigin="anonymous"></script>
<script>
// Build socket io connection
var socket = io.connect(":3000");

var chatHistory = $('#chat-history');
var chatList = $('#chat-list');
var myUserId = '<%= activeUser._id %>';

function requestChat(chatId, onSuccess, onError) {
    $.ajax({
        url: '/chats/' + chatId,
        method: 'GET',
        success: (data) => onSuccess(data)
    }).fail((data) => onError(data));
}

function populateChatHistory(chat) {
    chatHistory.empty();
    chat.messages.forEach((message) => buildAndShowMessageDiv(message));
    window.scroll(0, document.documentElement.offsetHeight);
}

function buildAndShowMessageDiv(message) {
    var messageDiv = '<div class="message';
    if (message.user._id == myUserId) {
        messageDiv += ' message-active-user';
    }
    messageDiv += '">';
    if (message.user._id != myUserId) {
        messageDiv += `<div class="message-author"><a href="/users/${message.user._id}">${message.user.firstName} ${message.user.lastName}</a></div>`;
    }
    messageDiv += `<div class="message-content">${message.content}</div>`;
    messageDiv += `<div class="message-timestamp">${moment(message.createdAt).fromNow()}</div>`;
    messageDiv += '</div>';
    chatHistory.append(messageDiv);
}

chatList.on('click', 'a', function (e) {
    var chatId = $(this).attr('data-chat-id');
    e.preventDefault();
    requestChat(
        chatId,
        (chat) => populateChatHistory(chat),
        (err) => alert(err)
    );
    chatList.children('.chat-item').each(function () {
        $(this).removeClass('active');
    });
    $(this).parent().addClass('active');
    $('#chat-form').attr('data-chat-id', chatId);
});


$(document).ready(function () {

   // Send message on submit
   $("#chat-form").submit(function (e) {
       // Prevent submit form from default (Reloading the page)
       e.preventDefault();

       var userInput = $("#message-input").val();
       if (userInput.length <= 0) {
           return;
       }

       // Define data for message with message content and chat id
       var data = {
           "message": userInput,
           "chatId": $(this).attr("data-chat-id"),
           "userId": "<%= activeUser._id %>"
       };

       // Send message data over socket
       socket.emit("message", data);

       // Clear message field
       $("#message-input").val("");

       // DEBUG - TODO Remove before live
       console.log(data);
   });

   // Catch single message
   socket.on('chat message', function (data) {

       // DEBUG - TODO Remove before live
       console.log(data);

       // Create date time object
       var dateTime = new Date();

       // Create user readable datetime object
       var time = dateTime.getHours() + ":" + dateTime.getMinutes() + ":" + dateTime.getSeconds();

       // Append message from user to list
       buildAndShowMessageDiv(data);
       window.scroll(0, document.documentElement.offsetHeight);
   })

   // Catch message from server
   socket.on("server-message", function (msg) {
       // Append message from server to list
       chatHistory.append(`<div class="server-message">${msg}</div>`);
   });
});

</script>

<% include ../partials/footer %>
